name: CI

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
    generate-matrix:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.generate.outputs.matrix }}
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
            - name: Generate test matrix
              id: generate
              run: node .github/scripts/generate-matrix.js

    test:
        needs: generate-matrix
        runs-on: ${{ matrix.os }}
        name: ${{ matrix.os-name }} / Node ${{ matrix.node-version }} / ${{ matrix.package-manager }}@${{ matrix.pm-version }}${{ matrix.package-manager != 'pnpm' && format(' (pnpm@{0})', matrix.pnpm-version) || '' }}
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - uses: pnpm/action-setup@v3
              with:
                  version: ${{ matrix.pnpm-version }}

            - uses: oven-sh/setup-bun@v1
              if: matrix.package-manager == 'bun'
              with:
                  bun-version: ${{ matrix.pm-version }}

            - uses: actions/setup-node@v4
              if: matrix.package-manager != 'bun'
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: ${{ matrix.package-manager }}

            - uses: actions/setup-node@v4
              if: matrix.package-manager == 'bun'
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Setup npm version
              if: matrix.package-manager == 'npm'
              shell: bash
              run: npm install -g npm@${{ matrix.pm-version }}

            - name: Install dependencies
              shell: bash
              run: ${{ matrix.package-manager }} install

            - name: Typecheck
              shell: bash
              run: ${{ matrix.package-manager }} run typecheck

            - name: Lint
              shell: bash
              run: ${{ matrix.package-manager }} run lint

            - name: Build
              shell: bash
              run: ${{ matrix.package-manager }} run build

            - name: Test
              shell: bash
              run: ${{ matrix.package-manager }} run test

            - name: Test CLI (dev mode via jiti)
              shell: bash
              run: |
                  ${{ matrix.cli-cmd }} --help | grep -q "Extract and reconstruct original source code"

            - name: Test CLI (built binary)
              shell: bash
              run: |
                  node packages/web2local/dist/index.mjs --help | grep -q "Extract and reconstruct original source code"

            - name: Test CLI serve subcommand
              shell: bash
              run: |
                  node packages/web2local/dist/index.mjs serve --help | grep -q "Serve captured API fixtures"

            - name: Test CLI (global install)
              shell: bash
              run: |
                  ${{ matrix.global-install-cmd }}
                  web2local --help | grep -q "Extract and reconstruct original source code"
                  web2local serve --help | grep -q "Serve captured API fixtures"
